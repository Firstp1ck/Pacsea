flowchart TD
    A([Start]) --> B[Add packages to Removal list]
    B --> C{List empty?}
    C -- Yes --> D[Prompt to select installed packages]
    C -- No --> E[Normalize list: dedupe, verify installed]
    E --> F{Protected/base packages detected?}
    F -- Yes --> F1[Warn; require explicit override per item]
    F -- No --> G{Tool available?<br/>pacman/paru/yay}
    F1 --> G
    G -- No --> G1[Show missing-tool guidance; abort]
    G -- Yes --> H{Dry-run?}
    H -- Yes --> I[Run dry-run removals; show orphans impact]
    H -- No --> J{User confirmed removal batch?}
    I --> J
    J -- No --> K[Cancel; preserve list]
    J -- Yes --> L[Acquire lock; prepare queue]
    L --> M{Process next item?}
    M -- No --> Z[Summarize success/fail, orphan hints]
    M -- Yes --> N[Check reverse deps; prompt keep/force]
    N --> O{Safe to remove?}
    O -- No --> O1[Skip item; mark blocked]
    O -- Yes --> P[Execute removal]
    P --> Q{Success?}
    Q -- Yes --> R[Mark success; optional clean orphans]
    Q -- No --> S[Mark failed; collect logs]
    R --> M
    S --> M
    Z --> AA([Done])

